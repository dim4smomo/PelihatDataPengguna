<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAPMAN Data Pengguna - GitHub Live</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; padding: 10px; font-size: 11px; }
        .container-fluid { max-width: 100% !important; }
        .card-header-custom { background: #0f172a; padding: 15px 25px; color: white; border-radius: 8px 8px 0 0; }
        .slogan-kami {
            font-size: 16px; font-weight: 900; color: #ff0000; 
            text-shadow: 0 0 12px rgba(255, 0, 0, 0.6);
            letter-spacing: 1.5px; margin-top: 4px; display: block; text-transform: uppercase;
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .sub-row-wrapper { background: #f8fafc; padding: 10px; border-radius: 4px; border: 1px solid #e2e8f0; }
        .json-key { font-family: 'JetBrains Mono'; color: #4f46e5; font-weight: 600; width: 180px; flex-shrink: 0; }
        .json-val { font-size: 10.5px; color: #334155; word-break: break-all; }
        .nested-content { display: none; margin-left: 15px; border-left: 1px solid #ff0000; padding-left: 10px; }
        .badge-active { background: #dcfce7; color: #15803d; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 9px; }
        .badge-inactive { background: #fee2e2; color: #b91c1c; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 9px; }
        table.dataTable thead th { font-size: 10px; padding: 8px !important; background: #f8fafc; text-transform: uppercase; }
        table.dataTable tbody td { font-size: 10.5px; padding: 5px 8px !important; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="spinner-border text-danger" role="status"></div>
    <div class="mt-3 fw-bold text-danger">MENGHUBUNGKAN KE GITHUB SIAPMAN...</div>
</div>

<div class="container-fluid">
    <div class="card border-0 shadow-sm">
        <div class="card-header-custom d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0 fw-bold">SIAPMAN Data Pengguna <span class="opacity-50" style="font-size: 0.7em;">(GitHub Live Mode)</span></h5>
                <span class="slogan-kami">Kami ada!!!</span>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="location.reload()" style="font-size: 10px;">REFRESH LIVE DATA</button>
        </div>
        
        <div class="card-body p-2">
            <div id="tableContainer" style="display:none">
                <div class="table-responsive">
                    <table id="mainTable" class="table table-sm table-hover w-100 border">
                        <thead>
                            <tr>
                                <th width="50"></th>
                                <th width="70">ID</th>
                                <th>NAMA LENGKAP</th>
                                <th>USERNAME</th>
                                <th>UNIT KERJA</th>
                                <th width="80">STATUS</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
const GITHUB_URL = "https://raw.githubusercontent.com/dim4smomo/PelihatDataPengguna/refs/heads/main/Data%20Pengguna.txt";

$(document).ready(function() {
    fetchLiveData();
});

async function fetchLiveData() {
    try {
        const response = await fetch(GITHUB_URL);
        if (!response.ok) throw new Error('Gagal koneksi ke GitHub');
        
        const rawText = await response.text();
        
        const jsonStart = rawText.indexOf('{"currentPage"');
        if (jsonStart === -1) throw new Error('Format data tidak valid');
        
        const data = JSON.parse(rawText.substring(jsonStart));
        renderTable(data.rows);
        
        $('#loader').fadeOut();
        $('#tableContainer').fadeIn();
    } catch (error) {
        alert("Error: " + error.message);
        $('#loader').hide();
    }
}

function generateNestedUI(obj) {
    let html = '';
    for (let key in obj) {
        if (!obj.hasOwnProperty(key)) continue;
        let val = obj[key];
        if (val !== null && typeof val === 'object') {
            html += `<div class="mt-1">
                        <button class="btn btn-light btn-sm py-0 px-1 border" style="font-size:8px" onclick="toggleSub(this)">+ ${key}</button>
                        <div class="nested-content" style="display:none; margin-left:15px; border-left:1px solid #ff0000; padding-left:10px;">${generateNestedUI(val)}</div>
                    </div>`;
        } else {
            html += `<div class="d-flex border-bottom py-1">
                        <div class="json-key">${key}</div>
                        <div class="json-val">${val === null ? 'null' : val}</div>
                    </div>`;
        }
    }
    return html;
}

function toggleSub(btn) {
    const div = btn.nextElementSibling;
    if (div.style.display === "none") {
        div.style.display = "block";
        btn.innerText = "- " + btn.innerText.substring(2);
    } else {
        div.style.display = "none";
        btn.innerText = "+ " + btn.innerText.substring(2);
    }
}

function renderTable(rows) {
    const table = $('#mainTable').DataTable({
        data: rows,
        pageLength: 50,
        dom: '<"d-flex justify-content-between p-2"lf>rtip',
        columns: [
            {
                className: 'dt-control text-center',
                data: null,
                render: () => '<button class="btn btn-dark btn-sm fw-bold" style="font-size:9px">DETAIL</button>'
            },
            { data: 'ID' },
            { data: 'Employee.Name', defaultContent: '-' },
            { data: 'Username' },
            { data: 'Employee.Company.Name', defaultContent: '-' },
            { 
                data: 'Active',
                render: d => d === 1 ? '<span class="badge-active">AKTIF</span>' : '<span class="badge-inactive">OFF</span>'
            }
        ]
    });

    $('#mainTable tbody').on('click', 'td.dt-control', function () {
        let tr = $(this).closest('tr');
        let row = table.row(tr);
        if (row.child.isShown()) {
            row.child.hide();
            $(this).find('button').text('DETAIL').removeClass('btn-danger').addClass('btn-dark');
        } else {
            row.child(`<div class="sub-row-wrapper">${generateNestedUI(row.data())}</div>`).show();
            $(this).find('button').text('TUTUP').removeClass('btn-dark').addClass('btn-danger');
        }
    });
}
</script>
</body>
</html>